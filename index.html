<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de Ingreso por DNI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 16px;
      background: #f5f5f9;
    }
    h2 { margin-bottom: 6px; }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      max-width: 430px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }

    label {
      font-size: 0.9rem;
      margin-top: 10px;
      display: block;
    }

    input {
      width: 95%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1rem;
      margin-top: 4px;
    }

    button {
      width: 100%;
      margin-top: 12px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      background: #304ffe;
      color: white;
      font-weight: 600;
    }

    button.secondary {
      background: #e0e0e0;
      color: #333;
    }

    button.success {
      background: #00c853;
    }

    .result p { margin: 6px 0; }

    .msg {
      margin-top: 10px;
      padding: 8px;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    .msg.error { background: #ffebee; color: #b71c1c; }
    .msg.info { background: #e3f2fd; color: #0d47a1; }

    video {
      width: 100%;
      border-radius: 12px;
      margin-top: 10px;
      background: black;
      min-height: 220px;
      object-fit: cover;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .stat-box {
      background: #f5f7ff;
      padding: 12px;
      border-radius: 8px;
    }

    .stat-box.secondary {
      background: #e8f5e9;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #555;
    }

    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
    }
  </style>
</head>

<body>

<h2>Control de Ingreso - Fiesta Navidad</h2>
<p style="font-size:0.85rem;color:#666;">Escanea o ingresa el DNI del titular</p>

<!-- RESUMEN -->
<div class="card">
  <h3>Resumen</h3>
  <div class="stats-grid">
    <div class="stat-box">
      <div class="stat-label">Familias</div>
      <div class="stat-value" id="indFamilias">0</div>
    </div>
    <div class="stat-box">
      <div class="stat-label">Personas Invitados</div>
      <div class="stat-value" id="indCapacidad">0</div>
    </div>
    <div class="stat-box secondary">
      <div class="stat-label">Familias dentro</div>
      <div class="stat-value" id="indDentroFam">0</div>
    </div>
    <div class="stat-box secondary">
      <div class="stat-label">Personas dentro</div>
      <div class="stat-value" id="indDentroPers">0</div>
    </div>
  </div>

  <button id="btnExportar" class="secondary">Exportar reporte</button>
</div>

<!-- CONSULTA -->
<div class="card">
  <label>DNI</label>
  <input id="dniInput" placeholder="Ej. 12345678" />

  <button id="btnConsultar">Consultar</button>
  <button id="btnCamara" class="secondary">Activar cámara</button>

  <div id="resultado" class="result"></div>

  <button id="btnIngreso" class="success" style="display:none;">
    Marcar ingreso
  </button>
</div>

<!-- CAMARA -->
<div class="card">
  <video id="video" autoplay playsinline style="display:none;"></video>
</div>

<!-- ZXING -->
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDBF1jOtLAMTIJjAWK7_YYJfBFiQWE3bXg",
    authDomain: "fiestanavidad-e89ef.firebaseapp.com",
    databaseURL: "https://fiestanavidad-e89ef-default-rtdb.firebaseio.com",
    projectId: "fiestanavidad-e89ef",
    storageBucket: "fiestanavidad-e89ef.firebasestorage.app",
    messagingSenderId: "295453440670",
    appId: "1:295453440670:web:54d2c1d93d8a0b4ee3198f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const dniInput = document.getElementById("dniInput");
  const resultado = document.getElementById("resultado");
  const btnIngreso = document.getElementById("btnIngreso");
  const video = document.getElementById("video");

  const indFamilias = document.getElementById("indFamilias");
  const indCapacidad = document.getElementById("indCapacidad");
  const indDentroFam = document.getElementById("indDentroFam");
  const indDentroPers = document.getElementById("indDentroPers");

  let invitados = {};
  let dniActual = null;
  let reader = null;
  let escaneando = false;

  onValue(ref(db, "INVITADOS"), snap => {
    invitados = snap.val() || {};
    actualizarIndicadores();
  });

  function actualizarIndicadores() {
    let familias = 0, capacidad = 0, dentroFam = 0, dentroPers = 0;

    Object.values(invitados).forEach(r => {
      familias++;
      const personas = Number(r.ASISTENCIA_TOTAL || 1);
      capacidad += personas;

      if (r.INGRESO) {
        dentroFam++;
        dentroPers += personas;
      }
    });

    indFamilias.textContent = familias;
    indCapacidad.textContent = capacidad;
    indDentroFam.textContent = dentroFam;
    indDentroPers.textContent = dentroPers;
  }

  document.getElementById("btnConsultar").onclick = () => {
    const dni = dniInput.value.trim();
    dniActual = dni;
    resultado.innerHTML = "";
    btnIngreso.style.display = "none";

    const r = invitados[dni];
    if (!r) {
      resultado.innerHTML = `<div class="msg error">DNI no registrado</div>`;
      return;
    }

    resultado.innerHTML = `
      <p><strong>${r.TITULAR_NOMBRE}</strong></p>
      <p>Área: ${r.AREA}</p>
      <p>Sede: ${r.SEDE}</p>
      <p>Titular: <strong>${r.ASISTENCIA_TITULAR}</strong></p>
      <p>Adicional: <strong>${r.ASISTENCIA_ADICIONAL}</strong></p>
      <p>Hijos: <strong>${r.ASISTENCIA_HIJOS}</strong></p>
      <p>Total: <strong>${r.ASISTENCIA_TOTAL}</strong></p>
      <p>Estado: ${r.INGRESO ? "✔ Ingresó" : "Pendiente"}</p>
    `;

    if (!r.INGRESO) btnIngreso.style.display = "block";
  };

  btnIngreso.onclick = async () => {
    const r = invitados[dniActual];
    if (!r || r.INGRESO) {
      alert("Este DNI ya registró ingreso");
      return;
    }

    await update(ref(db, "INVITADOS/" + dniActual), {
      INGRESO: true,
      FECHA_INGRESO: new Date().toISOString()
    });

    alert("Ingreso registrado ✔");
    btnIngreso.style.display = "none";
  };

  document.getElementById("btnCamara").onclick = async () => {
    if (!reader) reader = new ZXing.BrowserMultiFormatReader();

    if (!escaneando) {
      escaneando = true;
      video.style.display = "block";

      reader.decodeFromVideoDevice(null, video, res => {
        if (res) {
          const match = res.getText().match(/\d{8}/);
          if (match) {
            dniInput.value = match[0];
            document.getElementById("btnConsultar").click();
            reader.reset();
            video.style.display = "none";
            escaneando = false;
          }
        }
      });
    }
  };

  document.getElementById("btnExportar").onclick = () => {
    let csv = "DNI,NOMBRE,AREA,SEDE,TOTAL,INGRESO,FECHA\n";
    Object.entries(invitados).forEach(([dni, r]) => {
      csv += `${dni},"${r.TITULAR_NOMBRE}",${r.AREA},${r.SEDE},${r.ASISTENCIA_TOTAL},${r.INGRESO ? "SI" : "NO"},${r.FECHA_INGRESO || ""}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "reporte_ingresos.csv";
    a.click();
  };
</script>

</body>
</html>
